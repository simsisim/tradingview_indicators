// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Price & Volume Breakout + Gap Detection + Earnings Screener
// Designed for TradingView Pine Screener: https://www.tradingview.com/pine-screener/
// IMPORTANT: Use on DAILY timeframe for accurate daily analysis

//@version=5
indicator("PV Gap Earnings Screener", shorttitle="PVGE Screener", overlay=false)

// ============================================================================
// INPUTS - All configurable parameters
// ============================================================================

// GROUP 1: PRICE & VOLUME BREAKOUT
var g1 = "Price & Volume Breakout"
enable_pv = input.bool(true, "Enable PV Breakout Scanning", group=g1)
price_period = input.int(60, "Price Breakout Period", minval=10, maxval=500,
     group=g1, tooltip="Number of bars to compare for highest/lowest price")
volume_period = input.int(60, "Volume Breakout Period", minval=10, maxval=500,
     group=g1, tooltip="Number of bars to compare for highest volume")
sma_length = input.int(200, "Trend Filter SMA", minval=20, maxval=500,
     group=g1, tooltip="Moving average for trend confirmation (above=bullish, below=bearish)")
pv_lookback = input.int(100, "Search Last N Days", minval=1, maxval=500,
     group=g1, tooltip="How far back to scan for breakout events")
pv_direction = input.string("Both", "Breakout Direction", options=["Long Only", "Short Only", "Both"],
     group=g1, tooltip="Filter for long/short breakouts")

// GROUP 2: GAP DETECTION
var g2 = "Gap Detection"
enable_gaps = input.bool(true, "Enable Gap Scanning", group=g2)
gap_threshold_1 = input.float(5.0, "Gap Threshold 1 (%)", minval=0.1, maxval=30.0,
     step=0.5, group=g2, tooltip="First gap threshold (default 5%)")
gap_threshold_2 = input.float(10.0, "Gap Threshold 2 (%)", minval=0.1, maxval=30.0,
     step=0.5, group=g2, tooltip="Second gap threshold (default 10%)")
gap_direction = input.string("Both", "Gap Direction", options=["Up Only", "Down Only", "Both"],
     group=g2, tooltip="Filter gap direction")
gap_lookback = input.int(100, "Search Last N Days", minval=1, maxval=500,
     group=g2, tooltip="How far back to scan for gap events")

// GROUP 3: EARNINGS
var g3 = "Earnings Data"
enable_earnings = input.bool(true, "Enable Earnings Tracking", group=g3,
     tooltip="Track past earnings dates (future earnings not available in Pine Script)")
earnings_max_days = input.int(120, "Max Days to Track", minval=30, maxval=500,
     group=g3, tooltip="Stop tracking earnings older than this many days")

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

// Convert timestamp to YYYYMMDD format
timeToYYYYMMDD(t) =>
    yearVal = year(t)
    monthVal = month(t)
    dayVal = dayofmonth(t)
    yearVal * 10000 + monthVal * 100 + dayVal

// ============================================================================
// PRICE & VOLUME BREAKOUT LOGIC
// ============================================================================

// Calculate breakout levels
price_highest = ta.highest(high, price_period)
price_lowest = ta.lowest(low, price_period)
volume_highest = ta.highest(volume, volume_period)
sma_trend = ta.sma(close, sma_length)

// Initialize variables for tracking breakouts
var float pv_long_days_ago = na
var float pv_long_date = na
var float pv_long_strength = na
var float pv_short_days_ago = na
var float pv_short_date = na
var float pv_short_strength = na

// Scan for breakouts in recent history
if enable_pv
    long_found = false
    short_found = false

    for i = 0 to pv_lookback - 1
        if not long_found and (pv_direction == "Long Only" or pv_direction == "Both")
            // Check for long breakout: close > highest high AND volume > highest volume AND above SMA
            historical_long = close[i] > ta.highest(high, price_period)[i+1] and
                             volume[i] > ta.highest(volume, volume_period)[i+1] and
                             close[i] > ta.sma(close, sma_length)[i]

            if historical_long
                long_found := true
                pv_long_days_ago := i
                pv_long_date := timeToYYYYMMDD(time[i])
                pv_long_strength := (close[i] - ta.highest(high, price_period)[i+1]) / ta.highest(high, price_period)[i+1] * 100

        if not short_found and (pv_direction == "Short Only" or pv_direction == "Both")
            // Check for short breakout: close < lowest low AND volume > highest volume AND below SMA
            historical_short = close[i] < ta.lowest(low, price_period)[i+1] and
                              volume[i] > ta.highest(volume, volume_period)[i+1] and
                              close[i] < ta.sma(close, sma_length)[i]

            if historical_short
                short_found := true
                pv_short_days_ago := i
                pv_short_date := timeToYYYYMMDD(time[i])
                pv_short_strength := (ta.lowest(low, price_period)[i+1] - close[i]) / ta.lowest(low, price_period)[i+1] * 100

    // Reset if not found
    if not long_found
        pv_long_days_ago := na
        pv_long_date := na
        pv_long_strength := na

    if not short_found
        pv_short_days_ago := na
        pv_short_date := na
        pv_short_strength := na

// Determine primary breakout (most recent)
pv_breakout_flag = 0.0
pv_days_ago = na
pv_date = na
pv_strength = na
pv_type = 0.0  // 1 = long, -1 = short, 0 = none

if not na(pv_long_days_ago) or not na(pv_short_days_ago)
    if na(pv_short_days_ago) or (not na(pv_long_days_ago) and pv_long_days_ago < pv_short_days_ago)
        // Long breakout is more recent
        pv_breakout_flag := 1
        pv_days_ago := pv_long_days_ago
        pv_date := pv_long_date
        pv_strength := pv_long_strength
        pv_type := 1
    else
        // Short breakout is more recent
        pv_breakout_flag := 1
        pv_days_ago := pv_short_days_ago
        pv_date := pv_short_date
        pv_strength := pv_short_strength
        pv_type := -1

// Additional PV metrics
volume_ratio = volume / ta.sma(volume, volume_period)
price_vs_sma_pct = (close - sma_trend) / sma_trend * 100

// ============================================================================
// GAP DETECTION LOGIC
// ============================================================================

// Initialize variables for gap tracking
var float gap1_days_ago = na
var float gap1_date = na
var float gap1_size = na
var float gap1_direction = na

var float gap2_days_ago = na
var float gap2_date = na
var float gap2_size = na
var float gap2_direction = na

// Scan for gaps in recent history
if enable_gaps
    gap1_found = false
    gap2_found = false

    for i = 1 to gap_lookback
        // Calculate gap percentage
        gap_pct = (open[i] - close[i+1]) / close[i+1] * 100
        gap_abs = math.abs(gap_pct)

        // Check direction filter
        direction_ok = gap_direction == "Both" or
                      (gap_direction == "Up Only" and gap_pct > 0) or
                      (gap_direction == "Down Only" and gap_pct < 0)

        // Check for threshold 1
        if not gap1_found and gap_abs >= gap_threshold_1 and direction_ok
            gap1_found := true
            gap1_days_ago := i
            gap1_date := timeToYYYYMMDD(time[i])
            gap1_size := gap_pct
            gap1_direction := gap_pct > 0 ? 1 : -1

        // Check for threshold 2
        if not gap2_found and gap_abs >= gap_threshold_2 and direction_ok
            gap2_found := true
            gap2_days_ago := i
            gap2_date := timeToYYYYMMDD(time[i])
            gap2_size := gap_pct
            gap2_direction := gap_pct > 0 ? 1 : -1

    // Reset if not found
    if not gap1_found
        gap1_days_ago := na
        gap1_date := na
        gap1_size := na
        gap1_direction := na

    if not gap2_found
        gap2_days_ago := na
        gap2_date := na
        gap2_size := na
        gap2_direction := na

// Gap flags
gap1_flag = not na(gap1_days_ago) ? 1.0 : 0.0
gap2_flag = not na(gap2_days_ago) ? 1.0 : 0.0

// ============================================================================
// EARNINGS DATA LOGIC
// ============================================================================

var float earnings_days_ago = na
var float earnings_date = na
var float earnings_90day_flag = na

if enable_earnings
    // Request earnings data (past only - future earnings not available)
    [earningsTime, _, _] = request.earnings(syminfo.tickerid, earnings.actual, barmerge.gaps_on)

    if not na(earningsTime)
        // Calculate days since last earnings
        earnings_bars = (time - earningsTime) / (1000 * 60 * 60 * 24)

        if earnings_bars <= earnings_max_days
            earnings_days_ago := earnings_bars
            earnings_date := timeToYYYYMMDD(earningsTime)

            // Flag if approaching 90-day earnings cycle (80-95 days)
            earnings_90day_flag := (earnings_bars >= 80 and earnings_bars <= 95) ? 1 : 0
        else
            // Too old, don't track
            earnings_days_ago := na
            earnings_date := na
            earnings_90day_flag := 0
    else
        earnings_days_ago := na
        earnings_date := na
        earnings_90day_flag := 0
else
    earnings_days_ago := na
    earnings_date := na
    earnings_90day_flag := 0

// ============================================================================
// COMPOSITE SIGNALS
// ============================================================================

// Any signal flag (useful for quick filtering)
any_signal = (pv_breakout_flag == 1 or gap1_flag == 1 or gap2_flag == 1) ? 1 : 0

// Combined score (weighted)
combined_score = 0.0
if pv_breakout_flag == 1
    combined_score += 30
if gap1_flag == 1
    combined_score += 20
if gap2_flag == 1
    combined_score += 30
if not na(earnings_days_ago) and earnings_days_ago <= 5
    combined_score += 10  // Recent earnings
if not na(earnings_90day_flag) and earnings_90day_flag == 1
    combined_score += 10  // Approaching earnings cycle

// ============================================================================
// SCREENER OUTPUTS - All plot() values become screener columns
// ============================================================================

// Price & Volume Breakout Outputs
plot(pv_breakout_flag, "PV Breakout Flag", display=display.data_window)
plot(pv_days_ago, "PV Days Ago", display=display.data_window)
plot(pv_date, "PV Breakout Date", display=display.data_window)
plot(pv_strength, "PV Strength %", display=display.data_window)
plot(pv_type, "PV Type", display=display.data_window)  // 1=long, -1=short, 0=none
plot(volume_ratio, "Volume Ratio", display=display.data_window)
plot(price_vs_sma_pct, "Price vs SMA %", display=display.data_window)

// Gap Detection Outputs - Threshold 1
plot(gap1_flag, "Gap1 Flag", display=display.data_window)
plot(gap1_days_ago, "Gap1 Days Ago", display=display.data_window)
plot(gap1_date, "Gap1 Date", display=display.data_window)
plot(gap1_size, "Gap1 Size %", display=display.data_window)
plot(gap1_direction, "Gap1 Direction", display=display.data_window)  // 1=up, -1=down

// Gap Detection Outputs - Threshold 2
plot(gap2_flag, "Gap2 Flag", display=display.data_window)
plot(gap2_days_ago, "Gap2 Days Ago", display=display.data_window)
plot(gap2_date, "Gap2 Date", display=display.data_window)
plot(gap2_size, "Gap2 Size %", display=display.data_window)
plot(gap2_direction, "Gap2 Direction", display=display.data_window)  // 1=up, -1=down

// Earnings Outputs
plot(earnings_days_ago, "Days Since Earnings", display=display.data_window)
plot(earnings_date, "Last Earnings Date", display=display.data_window)
plot(earnings_90day_flag, "Earnings 90-Day Flag", display=display.data_window)

// Composite Outputs
plot(any_signal, "Any Signal", display=display.data_window)
plot(combined_score, "Combined Score", display=display.data_window)

// ============================================================================
// VISUAL ELEMENTS (for individual chart viewing, not screener)
// ============================================================================

// Background colors
bgcolor(pv_breakout_flag == 1 and pv_type == 1 ? color.new(color.green, 95) :
       pv_breakout_flag == 1 and pv_type == -1 ? color.new(color.red, 95) : na,
       title="PV Breakout Background")

bgcolor(gap2_flag == 1 ? color.new(color.orange, 95) : na,
       title="Major Gap Background")

// Shape markers
plotshape(pv_breakout_flag == 1 and pv_type == 1, "Long Breakout",
         style=shape.triangleup, location=location.bottom,
         color=color.green, size=size.small)

plotshape(pv_breakout_flag == 1 and pv_type == -1, "Short Breakout",
         style=shape.triangledown, location=location.top,
         color=color.red, size=size.small)

plotshape(gap2_flag == 1 and gap2_direction == 1, "Major Gap Up",
         style=shape.diamond, location=location.bottom,
         color=color.orange, size=size.tiny)

plotshape(gap2_flag == 1 and gap2_direction == -1, "Major Gap Down",
         style=shape.diamond, location=location.top,
         color=color.orange, size=size.tiny)

// Reference lines
hline(0, "Zero Line", color=color.gray, linestyle=hline.style_dashed)
hline(1, "Signal Line", color=color.white, linestyle=hline.style_dotted)

// ============================================================================
// INFORMATION TABLE (for individual chart viewing)
// ============================================================================

var table info_table = table.new(position.top_right, 2, 10,
     bgcolor=color.new(color.black, 80), border_width=1, border_color=color.gray)

if barstate.islast
    table.cell(info_table, 0, 0, "Metric", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(info_table, 1, 0, "Value", text_color=color.white, bgcolor=color.new(color.gray, 50))

    // PV Breakout
    table.cell(info_table, 0, 1, "PV Breakout", text_color=color.white)
    table.cell(info_table, 1, 1,
         pv_breakout_flag == 1 ? (pv_type == 1 ? "LONG ✓" : "SHORT ✓") : "No",
         text_color=pv_breakout_flag == 1 ? (pv_type == 1 ? color.green : color.red) : color.gray)

    table.cell(info_table, 0, 2, "PV Days Ago", text_color=color.white)
    table.cell(info_table, 1, 2,
         not na(pv_days_ago) ? str.tostring(pv_days_ago, "#") : "N/A",
         text_color=color.yellow)

    // Gap 1
    table.cell(info_table, 0, 3, "Gap " + str.tostring(gap_threshold_1, "#.#") + "%", text_color=color.white)
    table.cell(info_table, 1, 3,
         gap1_flag == 1 ? str.tostring(gap1_size, "#.##") + "%" : "No",
         text_color=gap1_flag == 1 ? color.orange : color.gray)

    table.cell(info_table, 0, 4, "Gap1 Days Ago", text_color=color.white)
    table.cell(info_table, 1, 4,
         not na(gap1_days_ago) ? str.tostring(gap1_days_ago, "#") : "N/A",
         text_color=color.yellow)

    // Gap 2
    table.cell(info_table, 0, 5, "Gap " + str.tostring(gap_threshold_2, "#.#") + "%", text_color=color.white)
    table.cell(info_table, 1, 5,
         gap2_flag == 1 ? str.tostring(gap2_size, "#.##") + "%" : "No",
         text_color=gap2_flag == 1 ? color.orange : color.gray)

    table.cell(info_table, 0, 6, "Gap2 Days Ago", text_color=color.white)
    table.cell(info_table, 1, 6,
         not na(gap2_days_ago) ? str.tostring(gap2_days_ago, "#") : "N/A",
         text_color=color.yellow)

    // Earnings
    table.cell(info_table, 0, 7, "Last Earnings", text_color=color.white)
    table.cell(info_table, 1, 7,
         not na(earnings_days_ago) ? str.tostring(earnings_days_ago, "#") + " days" : "N/A",
         text_color=color.aqua)

    table.cell(info_table, 0, 8, "90-Day Cycle", text_color=color.white)
    table.cell(info_table, 1, 8,
         earnings_90day_flag == 1 ? "YES ⚠" : "No",
         text_color=earnings_90day_flag == 1 ? color.yellow : color.gray)

    // Combined Score
    table.cell(info_table, 0, 9, "Combined Score", text_color=color.white)
    table.cell(info_table, 1, 9, str.tostring(combined_score, "#"),
         text_color=combined_score >= 50 ? color.green : combined_score >= 30 ? color.yellow : color.gray)

// ============================================================================
// USAGE INSTRUCTIONS
// ============================================================================
//
// PINE SCREENER SETUP:
// 1. Add this indicator to a DAILY chart
// 2. Configure input settings (periods, thresholds)
// 3. Open Pine Screener: https://www.tradingview.com/pine-screener/
// 4. Add this indicator to screener columns
// 5. Use filters and sorting to find opportunities
//
// EXAMPLE FILTERS:
// - Recent breakouts: PV Breakout Flag = 1 AND PV Days Ago <= 5
// - Big gaps: Gap2 Flag = 1 AND Gap2 Days Ago <= 10
// - Post-earnings plays: Days Since Earnings >= 7 AND Days Since Earnings <= 14
// - Pre-earnings setups: Earnings 90-Day Flag = 1 AND PV Breakout Flag = 1
// - High conviction: Combined Score >= 50
//
// DATE FORMAT:
// - Dates shown as YYYYMMDD (e.g., 20,260,127.00 = Jan 27, 2026)
// - Ignore commas and decimals, read as: 2026/01/27
//
// LIMITATIONS:
// - 500-bar historical limit (~2 years on daily charts)
// - Past earnings only (future earnings not available in Pine Script)
// - Same settings apply to all symbols in screener
// - For future earnings, use TradingView Stock Screener or earnings calendar
//
