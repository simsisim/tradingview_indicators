//@version=6
//@version=5
indicator("io_PVscreener_v2", overlay=false, shorttitle="BreakoutScan")

// Input Parameters
input_price_length = input.int(60, "Price Breakout Length", minval=1)
input_volume_length = input.int(60, "Volume Breakout Length", minval=1)
input_sma_length = input.int(200, "SMA Length", minval=1)
input_lookback_days = input.int(10, "Scan Last N Days", minval=1, maxval=50)

// Calculate breakout levels
price_highest = ta.highest(high, input_price_length)
price_lowest = ta.lowest(low, input_price_length)
volume_highest = ta.highest(volume, input_volume_length)
sma_trend = ta.sma(close, input_sma_length)

// Check for breakouts in the last N days
var float long_breakout_signal = 0
var float short_breakout_signal = 0
var float any_breakout_signal = 0
var float days_since_breakout = 0
var float breakout_strength_pct = 0

// Reset and check for recent breakouts
long_found = false
short_found = false

for i = 0 to input_lookback_days - 1
    if not long_found and not short_found
        historical_long_breakout = close[i] > ta.highest(high, input_price_length)[i+1] and 
                                  volume[i] > ta.highest(volume, input_volume_length)[i+1] and 
                                  close[i] > ta.sma(close, input_sma_length)[i]
        
        historical_short_breakout = close[i] < ta.lowest(low, input_price_length)[i+1] and 
                                   volume[i] > ta.highest(volume, input_volume_length)[i+1] and 
                                   close[i] < ta.sma(close, input_sma_length)[i]
        
        if historical_long_breakout
            long_found := true
            long_breakout_signal := 1
            short_breakout_signal := 0
            any_breakout_signal := 1
            days_since_breakout := i
            breakout_strength_pct := (close[i] - ta.highest(high, input_price_length)[i+1]) / ta.highest(high, input_price_length)[i+1] * 100
        else if historical_short_breakout
            short_found := true
            long_breakout_signal := 0
            short_breakout_signal := 1
            any_breakout_signal := 1
            days_since_breakout := i
            breakout_strength_pct := (ta.lowest(low, input_price_length)[i+1] - close[i]) / ta.lowest(low, input_price_length)[i+1] * 100

if not long_found and not short_found
    long_breakout_signal := 0
    short_breakout_signal := 0
    any_breakout_signal := 0
    days_since_breakout := -1
    breakout_strength_pct := 0

// Additional useful metrics
volume_ratio = volume / ta.sma(volume, input_volume_length)
price_distance_from_sma = (close - sma_trend) / sma_trend * 100
rsi_value = ta.rsi(close, 14)

// IMPORTANT: These plots make the values available in the screener
plot(long_breakout_signal, title="Long Breakout Signal", display=display.data_window)
plot(short_breakout_signal, title="Short Breakout Signal", display=display.data_window) 
plot(any_breakout_signal, title="Any Breakout Signal", display=display.data_window)
plot(days_since_breakout, title="Days Since Breakout", display=display.data_window)
plot(breakout_strength_pct, title="Breakout Strength %", display=display.data_window)
plot(volume_ratio, title="Volume Ratio", display=display.data_window)
plot(price_distance_from_sma, title="Price vs SMA %", display=display.data_window)
plot(rsi_value, title="RSI", display=display.data_window)

// Visual elements for chart viewing
plotshape(long_breakout_signal == 1, style=shape.triangleup, location=location.bottom, 
          color=color.green, size=size.small, title="Long Signal Marker")
plotshape(short_breakout_signal == 1, style=shape.triangledown, location=location.top, 
          color=color.red, size=size.small, title="Short Signal Marker")

// Background color
bgcolor(long_breakout_signal == 1 ? color.new(color.green, 90) : short_breakout_signal == 1 ? color.new(color.red, 90) : na, title="Signal Background")

// Horizontal reference lines
hline(0, "Zero Line", color=color.gray, linestyle=hline.style_dashed)
hline(1, "Signal Line", color=color.white, linestyle=hline.style_dotted)
