// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © YourName
//@version=5
indicator("io_PV_screener", overlay=false)

// Input Parameters
input_price_length = input.int(60, "Price Breakout Length", minval=1)
input_volume_length = input.int(60, "Volume Breakout Length", minval=1)
input_sma_length = input.int(200, "SMA Length", minval=1)
input_lookback_days = input.int(10, "Scan Last N Days", minval=1, maxval=50)

// Calculate breakout levels
price_highest = ta.highest(high, input_price_length)
price_lowest = ta.lowest(low, input_price_length)
volume_highest = ta.highest(volume, input_volume_length)
sma_trend = ta.sma(close, input_sma_length)

// Breakout conditions
long_breakout_today = close > price_highest[1] and volume > volume_highest[1] and close > sma_trend
short_breakout_today = close < price_lowest[1] and volume > volume_highest[1] and close < sma_trend

// Check for breakouts in the last N days
var bool long_breakout_recent = false
var bool short_breakout_recent = false
var int breakout_days_ago = 0

// Reset flags daily
if ta.change(time("1D")) != 0
    long_breakout_recent := false
    short_breakout_recent := false
    breakout_days_ago := 0

// Scan for breakouts in recent days
for i = 0 to input_lookback_days - 1
    historical_long_breakout = close[i] > ta.highest(high, input_price_length)[i+1] and 
                              volume[i] > ta.highest(volume, input_volume_length)[i+1] and 
                              close[i] > ta.sma(close, input_sma_length)[i]
    
    historical_short_breakout = close[i] < ta.lowest(low, input_price_length)[i+1] and 
                               volume[i] > ta.highest(volume, input_volume_length)[i+1] and 
                               close[i] < ta.sma(close, input_sma_length)[i]
    
    if historical_long_breakout and not long_breakout_recent
        long_breakout_recent := true
        breakout_days_ago := i
        break
    
    if historical_short_breakout and not short_breakout_recent
        short_breakout_recent := true
        breakout_days_ago := i
        break

// Screener outputs (these are the key values TradingView will use)
long_signal = long_breakout_recent
short_signal = short_breakout_recent
any_breakout = long_breakout_recent or short_breakout_recent

// Additional useful metrics for screening
breakout_strength = long_breakout_recent ? (close - price_highest[breakout_days_ago+1]) / price_highest[breakout_days_ago+1] * 100 : 
                   short_breakout_recent ? (price_lowest[breakout_days_ago+1] - close) / price_lowest[breakout_days_ago+1] * 100 : 0

volume_ratio = volume / ta.sma(volume, input_volume_length)
price_vs_sma = (close - sma_trend) / sma_trend * 100

// Plot the main signals (for visualization when viewing individual charts)
plotshape(long_breakout_today, style=shape.triangleup, location=location.belowbar, 
          color=color.green, size=size.normal, title="Long Breakout Today")
plotshape(short_breakout_today, style=shape.triangledown, location=location.abovebar, 
          color=color.red, size=size.normal, title="Short Breakout Today")

// Plot trend line
plot(sma_trend, color=color.white, linewidth=1, title="SMA Trend")

// Background color for recent breakouts
bgcolor(long_breakout_recent ? color.new(color.green, 95) : short_breakout_recent ? color.new(color.red, 95) : na, title="Recent Breakout Background")

// Table for current symbol details (optional, for when viewing individual charts)
var table info_table = table.new(position.top_right, 2, 6, bgcolor=color.black, border_width=1)

if barstate.islast
    table.cell(info_table, 0, 0, "Metric", text_color=color.white, bgcolor=color.gray)
    table.cell(info_table, 1, 0, "Value", text_color=color.white, bgcolor=color.gray)
    
    table.cell(info_table, 0, 1, "Long Signal", text_color=color.white, bgcolor=color.black)
    table.cell(info_table, 1, 1, long_signal ? "YES" : "NO", 
               text_color=long_signal ? color.green : color.gray, bgcolor=color.black)
    
    table.cell(info_table, 0, 2, "Short Signal", text_color=color.white, bgcolor=color.black)
    table.cell(info_table, 1, 2, short_signal ? "YES" : "NO", 
               text_color=short_signal ? color.red : color.gray, bgcolor=color.black)
    
    table.cell(info_table, 0, 3, "Days Ago", text_color=color.white, bgcolor=color.black)
    table.cell(info_table, 1, 3, any_breakout ? str.tostring(breakout_days_ago) : "N/A", 
               text_color=color.yellow, bgcolor=color.black)
    
    table.cell(info_table, 0, 4, "Strength %", text_color=color.white, bgcolor=color.black)
    table.cell(info_table, 1, 4, any_breakout ? str.tostring(breakout_strength, "#.##") + "%" : "N/A", 
               text_color=color.white, bgcolor=color.black)
    
    table.cell(info_table, 0, 5, "Vol Ratio", text_color=color.white, bgcolor=color.black)
    table.cell(info_table, 1, 5, str.tostring(volume_ratio, "#.##") + "x", 
               text_color=color.white, bgcolor=color.black)
